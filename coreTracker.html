<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ArUco Tracker with Spaghetti Chart & Zones</title>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    canvas { display: block; }
    #video { position: absolute; top: 0; left: 0; z-index: -1; }
    #captureButton { position: absolute; top: 10px; left: 10px; z-index: 10; padding: 8px 12px; }
  </style>
    <script type="importmap">
  {
    "imports": {
      "three": "./three.js-dev/build/three.module.js",
      "three/addons/": "./three.js-dev/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <button id="captureButton">Capture Item Location</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  <canvas id="spaghettiChartCanvas"></canvas>

  <script type="module">
    import * as THREE from 'three';
    import AR from './js-aruco2-master/src/aruco.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import POS from './js-aruco2-master/src/posit1.js';

    // Elements & contexts
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Marker real size in meters
    const markerSize = 0.04;

    // POSIT setup
    const posit = new POS.Posit(markerSize, canvas.width);

    // Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('spaghettiChartCanvas') });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableZoom = true;
    controls.minDistance = 2;
    controls.maxDistance = 50;

    camera.position.set(0, 10, 20);
    camera.up.set(0, 0, -1);
    camera.lookAt(0, 0, 0);
    controls.update();

    scene.add(new THREE.GridHelper(10, 10));

    // Forklift path line
    const lineMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 });
    let points = [];
    let lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
    const line = new THREE.Line(lineGeometry, lineMaterial);
    scene.add(line);

    // ArUco detector
    const detector = new AR.Detector({ dictionaryName: 'ARUCO' });

    // Forklift position vector
    const forkliftPos = new THREE.Vector3();

    // Smoothing variables
    let smoothedPos = null;
    const smoothingAlpha = 0.2; // EMA smoothing factor
    const maxDistanceJump = 1.5; // max allowed jump between frames to avoid outliers

    // Current zone marker id (null if none)
    let currentZoneId = null;

    // Store captured items here
    const storedItems = [];

    // Access webcam
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          posit._width = canvas.width; // update POSIT width
          animate();
        };
      })
      .catch(err => {
        alert('Error accessing webcam: ' + err);
      });

    // Estimate pose with POSIT for each marker
    function estimatePose(marker) {
      const corners = marker.corners.map(c => ({ x: c.x, y: c.y }));
      const pose = posit.pose(corners);
      if (!pose || !pose.bestRotation || !pose.bestTranslation) return null;
      return {
        translation: pose.bestTranslation,
        rotation: pose.bestRotation
      };
    }

    function animate() {
      requestAnimationFrame(animate);

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const markers = detector.detect(imageData);

        let sumPos = new THREE.Vector3(0, 0, 0);
        let totalWeight = 0;
        let closestMarker = null;
        let closestZ = Infinity;

        markers.forEach(marker => {
          const pose = estimatePose(marker);
          if (!pose) return;

          const t = pose.translation;
          if (
            isNaN(t[0]) || isNaN(t[1]) || isNaN(t[2]) ||
            !isFinite(t[0]) || !isFinite(t[1]) || !isFinite(t[2])
          ) return;

          const pos = new THREE.Vector3(t[0], -t[1], -t[2]);
          if (isNaN(pos.z) || !isFinite(pos.z)) return;

          // Accumulate for average pose
          sumPos.add(pos);
          totalWeight++;

          if (pos.z < closestZ) {
            closestZ = pos.z;
            closestMarker = marker;
          }
        });

        if (closestMarker) {
          currentZoneId = closestMarker.id;
        } else {
          currentZoneId = null;
        }

        if (totalWeight > 0) {
          const avgPos = sumPos.divideScalar(totalWeight);

          if (!smoothedPos) {
            smoothedPos = avgPos.clone();
          } else {
            if (smoothedPos.distanceTo(avgPos) > maxDistanceJump) {
              // Skip big jumps (likely outliers)
              console.warn('Outlier detected, skipping frame');
            } else {
              smoothedPos.lerp(avgPos, smoothingAlpha);
            }
          }

          forkliftPos.copy(smoothedPos);

          // Bonus tip: push every frame for smooth continuous line
          points.push(forkliftPos.clone());
          if (points.length > 500) points.shift();

          line.geometry.dispose();
          line.geometry = new THREE.BufferGeometry().setFromPoints(points);
        }

        controls.update();
        renderer.render(scene, camera);
      }
    }

    document.getElementById('captureButton').addEventListener('click', () => {
      const itemID = prompt('Enter Item ID:');
      if (!itemID) return alert('Item ID is required');

      storedItems.push({
        id: itemID,
        position: forkliftPos.clone(),
        zoneMarkerId: currentZoneId || 'Unknown',
        timestamp: new Date()
      });

      alert(`Captured ${itemID} at position (${forkliftPos.x.toFixed(2)}, ${forkliftPos.y.toFixed(2)}, ${forkliftPos.z.toFixed(2)}) in zone (marker ID): ${currentZoneId || 'Unknown'}`);
      console.log('Stored item', itemID, 'at position', forkliftPos, 'in zone marker ID', currentZoneId);
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
